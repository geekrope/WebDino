<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <script>
        var jumping = false;
        var adjoin = false;
        var salto = false;
        var frame = 0;
        var night = false;
        const ground = 400;
        var frames = 60;
        var jumpHeight = 250;
        var angle = 0;
        var walk1 = new Image();
        var walk2 = new Image();
        var walk3 = new Image();
        var cactus = new Image();
        var groundImg = new Image();
        var currentRes = null;
        var resInd = 0;
        var tick = 0;
        var a = 100;
        var speed = 10;
        var score = 0;
        var xOffset = 0;
        var started = false;
        const cactusSpawnX = 1920;
        let cactuses = [];
        var colider = {
            x: 100,
            y: ground,
            width: a,
            height: a
        }
        function IsImageOk(img) {
            if (!img.complete) {
                return false;
            }
            if (img.naturalWidth === 0) {
                return false;
            }            
            return true;
        }
        function StartGame() {
            var is1 = IsImageOk(walk1);
            var is2 = IsImageOk(walk2);
            var is3 = IsImageOk(walk3);
            var is4 = IsImageOk(cactus);
            var is5 = IsImageOk(groundImg);
            if (is1 && is2 && is3 && is4 & is5 && !started) {
                started = true;
                setInterval(Update, 10);
                colider = {
                    x: 100,
                    y: ground,
                    width: a * walk1.width / walk1.height,
                    height: a
                }
            }
        }
        function LoadResources() {
            walk1.src = "dinoSprites/walk1.png";
            walk2.src = "dinoSprites/walk2.png";
            walk3.src = "dinoSprites/walk3.png";
            cactus.src = "dinoSprites/cactus1.png";
            groundImg.src = "dinoSprites/ground.png";
            walk1.onload = StartGame;
            walk2.onload = StartGame;
            walk3.onload = StartGame;
            cactus.onload = StartGame;
            groundImg.onload = StartGame;
        }
        function Start() {
            cactuses = [];
            LoadResources();
            var cnv = document.getElementById("cnvs");
            document.onkeydown = function (e) {
                if (e.keyCode == "32" && !salto) {
                    jumping = true;
                }
                if (e.keyCode == "83" && !jumping) {
                    salto = true;
                }
            }
        }
        function Draw() {
            var ctx = document.getElementById("cnvs").getContext('2d');
            if (night && ctx.filter == "none") {
                ctx.filter = "invert(1)";
            }
            if (!night && !ctx.filter == "none") {
                ctx.filter = "none";
            }
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, innerWidth, innerHeight);
            var x1 = xOffset % groundImg.width;
            ctx.drawImage(groundImg, x1, ground + a - groundImg.height);
            ctx.drawImage(groundImg, x1 + groundImg.width, ground + a - groundImg.height);
            ctx.fillStyle = "#0000ff";
            //ctx.fillRect(colider.x, colider.y, colider.width, colider.height);
            for (var index = 0; index < cactuses.length; index++) {
                ctx.drawImage(cactus, cactuses[index].x, cactuses[index].y, cactus.width / cactus.height * cactuses[index].height, cactuses[index].height);
            }
            ctx.save();
            ctx.translate(colider.x + colider.width / 2, colider.y + colider.height / 2);
            ctx.rotate(angle / 180 * Math.PI);
            ctx.translate(-colider.x - colider.width / 2, -colider.y - colider.height / 2);
            ctx.drawImage(currentRes, colider.x, colider.y, currentRes.width / currentRes.height * colider.height, colider.height);
            ctx.restore();            
            ctx.fillStyle = "#000000";
            ctx.font = "24px ScoreFont";
            ctx.fillText(score.toString(), 5, 29);         
        }
        function Jump() {
            if (jumping) {
                frame++;
                colider.y = ground + Math.abs(Math.pow((frame - frames / 2) / (frames / 2) * Math.sqrt(jumpHeight), 2)) - jumpHeight;
                if (frame >= frames) {
                    frame = 0;
                    jumping = false;
                }
                Draw();
            }
        }
        function Salto() {
            if (salto) {
                var ctx = document.getElementById("cnvs").getContext('2d');
                frame++;
                angle += 360 / frames;
                if (frame >= frames) {
                    frame = 0;
                    salto = false;
                    angle = 0;
                }
                colider.y = ground + Math.abs(Math.pow((frame - frames / 2) / (frames / 2) * Math.sqrt(jumpHeight), 2)) - jumpHeight;
                Draw();
            }
        }
        function AddCactus(height, cactusSpawnx) {
            var cactus2 = {
                x: cactusSpawnx,
                y: ground + (1-height/a)*a,
                width: height * cactus.width / cactus.height,
                height: height
            }
            cactuses.push(cactus2);
        }
        function GetCactusWidth(height) {
            return height * cactus.width / cactus.height;
        }
        function Update() {
            var rand = Math.random();
            if (score % 1000 == 0) {
                //night = !night;
            }
            if (rand > 0.19 && rand < 0.2) {
                var rand2 = Math.random();
                if (cactuses.length == 0) {
                    if (rand2 < 0.33) {
                        AddCactus(a, cactusSpawnX);
                    }
                    if (rand2 > 0.33 && rand2 < 0.66) {
                        AddCactus(a, cactusSpawnX);
                        AddCactus(a / 1.5, cactusSpawnX + GetCactusWidth(a)+10);
                    }
                    else {
                        AddCactus(a/1.25, cactusSpawnX - GetCactusWidth(a/1.25)-10);
                        AddCactus(a, cactusSpawnX);
                        AddCactus(a / 1.5, cactusSpawnX + GetCactusWidth(a)+10);
                    }
                }
                else if (cactuses.length > 0) {
                    if (cactusSpawnX - cactuses[cactuses.length - 1].x > speed * 100) {
                        if (rand2 < 0.33) {
                            AddCactus(a, cactusSpawnX);
                        }
                        else if (rand2 > 0.33 && rand2 < 0.66) {
                            AddCactus(a, cactusSpawnX);
                            AddCactus(a / 1.5, cactusSpawnX + GetCactusWidth(a) + 10);
                        }
                        else {
                            AddCactus(a / 1.25, cactusSpawnX - GetCactusWidth(a / 1.25) - 10);
                            AddCactus(a, cactusSpawnX);
                            AddCactus(a / 1.5, cactusSpawnX + GetCactusWidth(a) + 10);
                        }
                    }
                }
            }
            for (var index = 0; index < cactuses.length; index++) {
                cactuses[index].x -= speed;
                if (cactuses[index].x + cactuses[index].width < 0) {
                    cactuses.splice(index, 1);
                }
            }
            xOffset -= speed;
            if (tick % 5 == 0)
            {
                score += 1;
            }
            if (!jumping && !salto && !adjoin) {
                if (resInd % 3 == 0 && tick % 5 == 0) {
                    currentRes = walk1;
                    resInd++;
                }
                if (resInd % 1 == 0 && tick % 5 == 0) {
                    currentRes = walk2;
                    resInd++;
                }
                if (resInd % 2 == 0 && tick % 5 == 0) {
                    currentRes = walk3;
                    resInd++;
                }
                Draw();
            }
            else {
                currentRes = walk1;
                Salto();
                Jump();
                resInd = 0;
            }
            tick++;
        }       
    </script>
    <style>
        @font-face {
            src: url("res/PressStart2P-Regular.ttf");
            font-family:ScoreFont;
        }
        canvas {
            image-rendering: optimizeSpeed; /* Older versions of FF          */
            image-rendering: -moz-crisp-edges; /* FF 6.0+                       */
            image-rendering: -webkit-optimize-contrast; /* Safari                        */
            image-rendering: -o-crisp-edges; /* OS X & Windows Opera (12.02+) */
            image-rendering: pixelated; /* Awesome future-browsers       */
            -ms-interpolation-mode: nearest-neighbor; /* IE                            */
        }
    </style>
</head>
<body onload="Start()" style="overflow:hidden;margin:0px;padding:0px">
    <canvas width="1920" style="margin:0px;padding:0px" height="1080" id="cnvs" />
</body>
</html>